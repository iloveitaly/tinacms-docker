# TinaCMS Docker Maintenance Guide

## Ongoing Maintenance Requirements

When TinaCMS or its dependencies are updated, here's what you need to maintain.

## 1. TinaCMS Package Updates

### What Changes

TinaCMS consists of several packages that update independently:

```json
{
  "@tinacms/cli": "^1.6.1",           // CLI tools, schema generation
  "@tinacms/datalayer": "^1.3.1",     // Backend API core
  "tinacms": "^2.2.1",                // Frontend editing UI
  "tinacms-authjs": "^5.0.1",         // Auth integration
  "tinacms-gitprovider-github": "^2.0.1" // Git provider
}
```

### How to Update

```bash
# Check for updates
npm outdated

# Update specific package
npm update tinacms

# Or update all TinaCMS packages
npm update @tinacms/cli @tinacms/datalayer tinacms tinacms-authjs tinacms-gitprovider-github

# Rebuild Docker image
docker-compose build --no-cache
docker-compose up -d
```

### Frequency
- **Minor versions**: Monthly to quarterly
- **Patch versions**: As needed for bug fixes
- **Major versions**: Annually (with breaking changes)

### Breaking Changes to Watch For

#### GraphQL Schema Changes
If TinaCMS updates its schema generation:

```typescript
// tina/__generated__/databaseClient.ts
// This file is auto-generated by `tinacms build`
```

**Action**: Rebuild the project to regenerate schema
```bash
npm run build  # Runs: tinacms build + next build
```

#### Database Adapter API Changes
The MongoDB adapter interface might change:

```typescript
// tina/database.ts
new MongodbLevel<string, Record<string, any>>({
  collectionName: "tinacms",
  dbName: "tinacms",
  mongoUri: process.env.MONGODB_URI as string,
})
```

**Action**: Check migration guide in TinaCMS release notes

#### Config File Changes
The `tina/config.tsx` structure may evolve:

```typescript
// Example: New config options
export default defineConfig({
  // New in v3.0: media provider options
  media: {
    tina: {
      // New required field
      storageProvider: "local" // or "s3", "cloudinary"
    }
  }
})
```

**Action**: Review breaking changes in changelog

---

## 2. Next.js Updates

### Current Version
```json
"next": "14.2.1"
```

### Major Version Updates (e.g., Next.js 14 → 15)

**Potential Breaking Changes:**

1. **Build Output Structure**
```dockerfile
# May need to update Dockerfile paths
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
```

2. **API Routes Changes**
```typescript
// pages/api/tina/[...routes].ts
// API route signature might change
export default (req, res) => {
  return handler(req, res);
}
```

3. **Configuration Changes**
```javascript
// next.config.js
module.exports = {
  output: 'standalone', // May be renamed or changed
}
```

### How to Update

```bash
# Update Next.js
npm update next

# Test locally first
npm run build
npm start

# If successful, rebuild Docker
docker-compose build --no-cache
```

### Frequency
- **Minor versions**: Every 2-3 months
- **Major versions**: Annually

---

## 3. MongoDB Adapter Updates

### Current Version
```json
"mongodb-level": "^0.0.4"
```

### What Could Change

The `mongodb-level` package is maintained by TinaCMS team but is still pre-1.0 (`^0.0.4`), indicating active development.

**Potential Changes:**

1. **Connection String Format**
```typescript
// Could change from:
mongoUri: process.env.MONGODB_URI

// To something like:
connection: {
  uri: process.env.MONGODB_URI,
  options: { ... }
}
```

2. **Collection Structure**
The way data is stored in MongoDB might change, requiring migration:

```bash
# May need to re-index from Git
docker-compose exec tinacms npm run tina-reindex
```

### How to Monitor
Watch the GitHub repository:
- https://github.com/tinacms/mongodb-level
- Subscribe to releases

---

## 4. Docker Base Image Updates

### Current Base
```dockerfile
FROM node:18-alpine
```

### When to Update

**Node.js Version Updates:**
- Node 18 → Node 20 → Node 22

**Why Update:**
- Security patches
- Performance improvements
- End of life for old versions

### How to Update

```dockerfile
# Change Dockerfile
FROM node:20-alpine AS base
RUN apk add --no-cache libc6-compat git
```

```bash
# Rebuild with new base
docker-compose build --no-cache
docker-compose up -d

# Test thoroughly
```

### Frequency
- **Patch versions**: Automatically via `:18-alpine` tag
- **Major versions**: Every 1-2 years

### Node.js LTS Schedule
- Node 18: Supported until April 2025
- Node 20: Supported until April 2026
- Node 22: Supported until April 2027

**Action Needed**: Update to Node 20 by April 2025

---

## 5. MongoDB Database Updates

### Current Version
```yaml
# docker-compose.yml
mongodb:
  image: mongo:7
```

### When to Update

MongoDB releases major versions periodically:
- Mongo 7 (current) → Mongo 8 (future)

### How to Update

**IMPORTANT**: Major MongoDB upgrades require careful planning.

```yaml
# docker-compose.yml
mongodb:
  image: mongo:8  # New version
```

**Migration Process:**

1. **Backup first**
```bash
docker-compose exec mongodb mongodump --out=/backup
docker cp $(docker-compose ps -q mongodb):/backup ./backup
```

2. **Stop containers**
```bash
docker-compose down
```

3. **Update docker-compose.yml**
```yaml
image: mongo:8
```

4. **Start with new version**
```bash
docker-compose up -d
```

5. **Verify data**
```bash
docker-compose exec mongodb mongosh tinacms
> db.tinacms.countDocuments()
```

### Frequency
- **Minor versions** (7.0 → 7.1): Quarterly
- **Major versions** (7 → 8): Every 1-2 years

---

## 6. Security Updates

### Dependencies with CVEs

When security vulnerabilities are discovered:

```bash
# Check for security issues
npm audit

# Fix automatically
npm audit fix

# If requires breaking changes
npm audit fix --force  # Careful!

# Rebuild Docker
docker-compose build --no-cache
```

### Docker Base Image Security

```bash
# Scan Docker image for vulnerabilities
docker scan tinacms-docker-starter:latest

# Or use Trivy
trivy image tinacms-docker-starter:latest
```

### Frequency
- **Critical CVEs**: Immediately
- **High severity**: Within 1 week
- **Medium/Low**: Next regular update cycle

---

## 7. GitHub API Changes

### Git Provider Updates

```json
"tinacms-gitprovider-github": "^2.0.1"
```

**What Could Change:**
- GitHub API v3 → v4 (GraphQL)
- Authentication methods
- Rate limits

**Action**: Monitor TinaCMS releases for git provider updates

---

## Maintenance Checklist

### Weekly
- [ ] Check Docker logs for errors: `docker-compose logs --tail=100`
- [ ] Verify backups are running
- [ ] Monitor disk space: `docker system df`

### Monthly
- [ ] Run `npm outdated` to check for updates
- [ ] Review TinaCMS GitHub releases: https://github.com/tinacms/tinacms/releases
- [ ] Check for security advisories
- [ ] Test backup restoration

### Quarterly
- [ ] Update patch versions: `npm update`
- [ ] Rebuild Docker image: `docker-compose build --no-cache`
- [ ] Run security scan: `npm audit`
- [ ] Review and clean old Docker images: `docker image prune -a`

### Annually
- [ ] Review major version updates (Next.js, Node.js, MongoDB)
- [ ] Plan migration for breaking changes
- [ ] Update base images (Node.js version)
- [ ] Review and update documentation

---

## Automated Update Strategy

### Option 1: Dependabot (GitHub)

Create `.github/dependabot.yml`:

```yaml
version: 2
updates:
  # NPM dependencies
  - package-ecosystem: "npm"
    directory: "/starter-template"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  # Docker base images
  - package-ecosystem: "docker"
    directory: "/starter-template"
    schedule:
      interval: "weekly"
```

**Pros:**
- Automatic PR creation
- Security updates highlighted
- Free for public repos

**Cons:**
- Requires manual testing and merging
- Can create many PRs

### Option 2: Renovate Bot

More configurable alternative to Dependabot:

```json
{
  "extends": ["config:base"],
  "packageRules": [
    {
      "matchPackagePatterns": ["^@tinacms", "tinacms"],
      "groupName": "TinaCMS packages"
    }
  ]
}
```

### Option 3: Manual with Script

Create `scripts/check-updates.sh`:

```bash
#!/bin/bash
echo "Checking for TinaCMS updates..."
npm outdated @tinacms/cli @tinacms/datalayer tinacms tinacms-authjs tinacms-gitprovider-github

echo "\nChecking for security issues..."
npm audit

echo "\nChecking Docker base image..."
docker pull node:18-alpine
docker pull mongo:7
```

Run monthly:
```bash
chmod +x scripts/check-updates.sh
./scripts/check-updates.sh
```

---

## Breaking Change Scenarios

### Scenario 1: TinaCMS 3.0 Major Release

**Hypothetical Breaking Changes:**

```typescript
// OLD (v2.x)
import { defineConfig } from "tinacms";

export default defineConfig({
  authProvider: new UsernamePasswordAuthJSProvider(),
  contentApiUrlOverride: "/api/tina/gql",
})

// NEW (v3.x) - hypothetical
import { createConfig } from "tinacms"; // Renamed!

export default createConfig({
  auth: {  // Restructured!
    provider: "authjs",
    type: "username-password"
  },
  api: {
    endpoint: "/api/tina/gql"
  }
})
```

**Migration Steps:**

1. **Read migration guide**
```bash
# Check TinaCMS docs
open https://tina.io/docs/migrating/v2-to-v3
```

2. **Update code**
```bash
# Follow guide to update tina/config.tsx
# Update tina/database.ts if needed
```

3. **Test locally**
```bash
npm install
npm run dev
# Test admin at /admin
```

4. **Update Docker**
```bash
docker-compose build --no-cache
docker-compose up -d
```

5. **Verify production**
```bash
docker-compose logs -f tinacms
# Test all functionality
```

### Scenario 2: MongoDB Adapter 1.0 Release

Currently `mongodb-level` is `^0.0.4` (pre-stable).

When 1.0 is released, expect:

**Potential Changes:**
- Stabilized API
- Better error handling
- Migration path from 0.x

**Action:**
```bash
# Update package
npm update mongodb-level

# Check for breaking changes
cat node_modules/mongodb-level/CHANGELOG.md

# May need to update tina/database.ts
# Follow official migration guide
```

---

## Testing After Updates

### Local Testing Checklist

```bash
# 1. Update packages
npm update

# 2. Build locally
npm run build

# 3. Start development server
npm run dev

# 4. Test in browser
# ✓ Homepage loads
# ✓ /admin loads
# ✓ Can login
# ✓ Can view content
# ✓ Can edit and save content
# ✓ Check GitHub for new commit
# ✓ No console errors
```

### Docker Testing Checklist

```bash
# 1. Rebuild image
docker-compose build --no-cache

# 2. Start containers
docker-compose up -d

# 3. Check logs
docker-compose logs -f tinacms

# 4. Verify health
curl http://localhost:3000/api/health

# 5. Test full workflow
# ✓ Access /admin
# ✓ Login works
# ✓ Edit content
# ✓ Save (commits to Git)
# ✓ Frontend reflects changes
```

---

## Rollback Strategy

If an update breaks something:

### Rollback NPM Packages

```bash
# Check previous working version
git log package.json

# Restore package.json
git checkout HEAD~1 package.json
git checkout HEAD~1 package-lock.json

# Reinstall
npm install

# Rebuild
docker-compose build --no-cache
docker-compose up -d
```

### Rollback Docker Image

```bash
# Find previous working image
docker images

# Tag current as backup
docker tag tinacms-docker-starter:latest tinacms-docker-starter:broken

# Use previous image
docker-compose down
docker-compose up -d
```

### Rollback Database (if needed)

```bash
# Stop containers
docker-compose down

# Remove volume
docker volume rm tinacms-docker_mongodb-data

# Restore from backup
docker volume create tinacms-docker_mongodb-data
docker run --rm -v tinacms-docker_mongodb-data:/data -v $(pwd)/backup:/backup alpine sh -c "cp -r /backup/* /data/"

# Start containers
docker-compose up -d
```

---

## Monitoring for Updates

### 1. GitHub Watch

Watch these repositories for releases:
- https://github.com/tinacms/tinacms
- https://github.com/tinacms/mongodb-level
- https://github.com/vercel/next.js

### 2. RSS Feeds

Subscribe to release feeds:
```
https://github.com/tinacms/tinacms/releases.atom
https://github.com/vercel/next.js/releases.atom
```

### 3. Discord/Slack

Join TinaCMS community:
- Discord: https://discord.com/invite/zumN63Ybpf
- Announcements channel for breaking changes

### 4. Email Notifications

Enable GitHub notifications for:
- Releases
- Security advisories

---

## Cost of Maintenance

### Time Investment

**Low Maintenance** (recommended approach):
- **Monthly**: 30 minutes (check updates, security scan)
- **Quarterly**: 2-3 hours (apply updates, rebuild, test)
- **Annually**: 4-8 hours (major version updates)

**Total**: ~15-20 hours per year

**High Maintenance** (stay on bleeding edge):
- **Weekly**: 1-2 hours (check and apply updates)
- **Total**: ~75-100 hours per year

### Recommended Strategy

**Stable Updates Only:**
1. Wait 2-4 weeks after major releases
2. Let others find breaking changes
3. Read migration guides before updating
4. Test in development first
5. Keep Docker images tagged by date

```bash
# Tag images with date
docker build -t tinacms:2024-11-12 .
docker tag tinacms:2024-11-12 tinacms:latest

# Easy rollback
docker-compose down
docker tag tinacms:2024-10-15 tinacms:latest
docker-compose up -d
```

---

## When NOT to Update

**Skip updates if:**

1. **Working perfectly**: "If it ain't broke, don't fix it"
2. **Major project deadline**: Wait until after launch
3. **No security issues**: Patch updates can wait
4. **Breaking changes unclear**: Wait for community feedback
5. **No testing capacity**: Better to stay stable

**Security exceptions**: Always update for critical CVEs, even if risky.

---

## Summary: Maintenance Burden

### Low (Recommended)
- Update quarterly
- Only security patches immediately
- ~15-20 hours/year
- Stable, predictable

### Medium
- Update monthly
- Stay 1-2 versions behind latest
- ~30-40 hours/year
- Good balance

### High
- Update weekly
- Always on latest
- ~75-100 hours/year
- Bleeding edge, more risk

### Minimal Maintenance Dependencies

The good news about this stack:

✅ **TinaCMS**: Stable API, infrequent breaking changes
✅ **Next.js**: Well-maintained, clear migration guides
✅ **MongoDB**: Database schema is simple (just cache)
✅ **Docker**: Once working, rarely needs changes
✅ **Git as source of truth**: Content always safe

**Biggest risk**: `mongodb-level` is still `0.0.x` (pre-1.0)
**Mitigation**: When 1.0 releases, budget time for migration

---

## Maintenance Automation Script

Create `scripts/maintenance.sh`:

```bash
#!/bin/bash
set -e

echo "=== TinaCMS Docker Maintenance Check ==="
echo ""

echo "1. Checking for outdated packages..."
npm outdated || true
echo ""

echo "2. Checking for security vulnerabilities..."
npm audit --audit-level=moderate || true
echo ""

echo "3. Checking Docker image sizes..."
docker images | grep tinacms
echo ""

echo "4. Checking disk usage..."
docker system df
echo ""

echo "5. Checking container status..."
docker-compose ps
echo ""

echo "6. Checking recent logs for errors..."
docker-compose logs --tail=50 tinacms | grep -i error || echo "No errors found"
echo ""

echo "=== Maintenance check complete ==="
```

Run monthly:
```bash
chmod +x scripts/maintenance.sh
./scripts/maintenance.sh > maintenance-$(date +%Y%m%d).log
```

---

## Conclusion

**Realistic maintenance burden**: ~15-20 hours per year for stable updates.

**Key principles**:
1. Don't update unless needed
2. Test locally before Docker
3. Always backup before major updates
4. Keep Git as source of truth (easy recovery)
5. Tag Docker images for easy rollback

**The good news**: TinaCMS is designed with stability in mind. Database is just a cache. Content is safe in Git. Most updates are non-breaking.

**Bottom line**: This is a low-maintenance deployment once set up correctly.
